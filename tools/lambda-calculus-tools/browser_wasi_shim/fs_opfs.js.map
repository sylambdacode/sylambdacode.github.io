{"version":3,"sources":["../src/fs_opfs.ts"],"sourcesContent":["import * as wasi from \"./wasi_defs.js\";\nimport { Fd, Inode } from \"./fd.js\";\n\n// Shim for https://developer.mozilla.org/en-US/docs/Web/API/FileSystemSyncAccessHandle\n// This is not part of the public interface.\nexport interface FileSystemSyncAccessHandle {\n  close(): void;\n  flush(): void;\n  getSize(): number;\n  read(buffer: ArrayBuffer | ArrayBufferView, options?: { at: number }): number;\n  truncate(to: number): void;\n  write(\n    buffer: ArrayBuffer | ArrayBufferView,\n    options?: { at: number },\n  ): number;\n}\n\n// Synchronous access to an individual file in the origin private file system.\n// Only allowed inside a WebWorker.\nexport class SyncOPFSFile extends Inode {\n  handle: FileSystemSyncAccessHandle;\n  readonly: boolean;\n\n  // FIXME needs a close() method to be called after start() to release the underlying handle\n  constructor(\n    handle: FileSystemSyncAccessHandle,\n    options?: Partial<{\n      readonly: boolean;\n    }>,\n  ) {\n    super();\n    this.handle = handle;\n    this.readonly = !!options?.readonly;\n  }\n\n  path_open(oflags: number, fs_rights_base: bigint, fd_flags: number) {\n    if (\n      this.readonly &&\n      (fs_rights_base & BigInt(wasi.RIGHTS_FD_WRITE)) ==\n        BigInt(wasi.RIGHTS_FD_WRITE)\n    ) {\n      // no write permission to file\n      return { ret: wasi.ERRNO_PERM, fd_obj: null };\n    }\n\n    if ((oflags & wasi.OFLAGS_TRUNC) == wasi.OFLAGS_TRUNC) {\n      if (this.readonly) return { ret: wasi.ERRNO_PERM, fd_obj: null };\n      this.handle.truncate(0);\n    }\n\n    const file = new OpenSyncOPFSFile(this);\n    if (fd_flags & wasi.FDFLAGS_APPEND) file.fd_seek(0n, wasi.WHENCE_END);\n    return { ret: wasi.ERRNO_SUCCESS, fd_obj: file };\n  }\n\n  get size(): bigint {\n    return BigInt(this.handle.getSize());\n  }\n\n  stat(): wasi.Filestat {\n    return new wasi.Filestat(this.ino, wasi.FILETYPE_REGULAR_FILE, this.size);\n  }\n}\n\nexport class OpenSyncOPFSFile extends Fd {\n  file: SyncOPFSFile;\n  position: bigint = 0n;\n  ino: bigint;\n\n  constructor(file: SyncOPFSFile) {\n    super();\n    this.file = file;\n    this.ino = Inode.issue_ino();\n  }\n\n  fd_allocate(offset: bigint, len: bigint): number {\n    if (BigInt(this.file.handle.getSize()) > offset + len) {\n      // already big enough\n    } else {\n      // extend\n      this.file.handle.truncate(Number(offset + len));\n    }\n    return wasi.ERRNO_SUCCESS;\n  }\n\n  fd_fdstat_get(): { ret: number; fdstat: wasi.Fdstat | null } {\n    return { ret: 0, fdstat: new wasi.Fdstat(wasi.FILETYPE_REGULAR_FILE, 0) };\n  }\n\n  fd_filestat_get(): { ret: number; filestat: wasi.Filestat } {\n    return {\n      ret: 0,\n      filestat: new wasi.Filestat(\n        this.ino,\n        wasi.FILETYPE_REGULAR_FILE,\n        BigInt(this.file.handle.getSize()),\n      ),\n    };\n  }\n\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  fd_filestat_set_size(size: bigint): number {\n    this.file.handle.truncate(Number(size));\n    return wasi.ERRNO_SUCCESS;\n  }\n\n  fd_read(size: number): { ret: number; data: Uint8Array } {\n    const buf = new Uint8Array(size);\n    const n = this.file.handle.read(buf, { at: Number(this.position) });\n    this.position += BigInt(n);\n    return { ret: 0, data: buf.slice(0, n) };\n  }\n\n  fd_seek(\n    offset: number | bigint,\n    whence: number,\n  ): { ret: number; offset: bigint } {\n    let calculated_offset: bigint;\n    switch (whence) {\n      case wasi.WHENCE_SET:\n        calculated_offset = BigInt(offset);\n        break;\n      case wasi.WHENCE_CUR:\n        calculated_offset = this.position + BigInt(offset);\n        break;\n      case wasi.WHENCE_END:\n        calculated_offset = BigInt(this.file.handle.getSize()) + BigInt(offset);\n        break;\n      default:\n        return { ret: wasi.ERRNO_INVAL, offset: 0n };\n    }\n    if (calculated_offset < 0) {\n      return { ret: wasi.ERRNO_INVAL, offset: 0n };\n    }\n    this.position = calculated_offset;\n    return { ret: wasi.ERRNO_SUCCESS, offset: this.position };\n  }\n\n  fd_write(data: Uint8Array): { ret: number; nwritten: number } {\n    if (this.file.readonly) return { ret: wasi.ERRNO_BADF, nwritten: 0 };\n\n    // don't need to extend file manually, just write\n    const n = this.file.handle.write(data, { at: Number(this.position) });\n    this.position += BigInt(n);\n    return { ret: wasi.ERRNO_SUCCESS, nwritten: n };\n  }\n\n  fd_sync(): number {\n    this.file.handle.flush();\n    return wasi.ERRNO_SUCCESS;\n  }\n}\n"],"names":["wasi","Fd","Inode","SyncOPFSFile","handle","readonly","options","path_open","oflags","fs_rights_base","fd_flags","BigInt","RIGHTS_FD_WRITE","ret","ERRNO_PERM","fd_obj","OFLAGS_TRUNC","truncate","file","OpenSyncOPFSFile","FDFLAGS_APPEND","fd_seek","WHENCE_END","ERRNO_SUCCESS","size","getSize","stat","Filestat","ino","FILETYPE_REGULAR_FILE","position","issue_ino","fd_allocate","offset","len","Number","fd_fdstat_get","fdstat","Fdstat","fd_filestat_get","filestat","fd_filestat_set_size","fd_read","buf","Uint8Array","n","read","at","data","slice","whence","calculated_offset","WHENCE_SET","WHENCE_CUR","ERRNO_INVAL","fd_write","ERRNO_BADF","nwritten","write","fd_sync","flush"],"mappings":"AAAA,UAAYA,SAAU,gBAAiB,AACvC,QAASC,EAAE,CAAEC,KAAK,KAAQ,SAAU,AAkBpC,QAAO,MAAMC,qBAAqBD,MAChCE,MAAmC,AACnCC,CAAAA,QAAkB,AAGlB,aACED,MAAkC,CAClCE,OAEE,CACF,CACA,KAAK,EACL,CAAA,IAAI,CAACF,MAAM,CAAGA,MACd,CAAA,IAAI,CAACC,QAAQ,CAAG,CAAC,CAACC,SAASD,QAC7B,CAEAE,UAAUC,MAAc,CAAEC,cAAsB,CAAEC,QAAgB,CAAE,CAClE,GACE,IAAI,CAACL,QAAQ,EACb,AAACI,CAAAA,eAAiBE,OAAOX,KAAKY,eAAe,CAAA,GAC3CD,OAAOX,KAAKY,eAAe,EAC7B,CAEA,MAAO,CAAEC,IAAKb,KAAKc,UAAU,CAAEC,OAAQ,IAAK,CAC9C,CAEA,GAAI,AAACP,CAAAA,OAASR,KAAKgB,YAAY,AAAD,GAAMhB,KAAKgB,YAAY,CAAE,CACrD,GAAI,IAAI,CAACX,QAAQ,CAAE,MAAO,CAAEQ,IAAKb,KAAKc,UAAU,CAAEC,OAAQ,IAAK,EAC/D,IAAI,CAACX,MAAM,CAACa,QAAQ,CAAC,EACvB,CAEA,MAAMC,KAAO,IAAIC,iBAAiB,IAAI,EACtC,GAAIT,SAAWV,KAAKoB,cAAc,CAAEF,KAAKG,OAAO,CAAC,CAAE,AAAF,CAAE,CAAErB,KAAKsB,UAAU,EACpE,MAAO,CAAET,IAAKb,KAAKuB,aAAa,CAAER,OAAQG,IAAK,CACjD,CAEA,IAAIM,MAAe,CACjB,OAAOb,OAAO,IAAI,CAACP,MAAM,CAACqB,OAAO,GACnC,CAEAC,MAAsB,CACpB,OAAO,IAAI1B,KAAK2B,QAAQ,CAAC,IAAI,CAACC,GAAG,CAAE5B,KAAK6B,qBAAqB,CAAE,IAAI,CAACL,IAAI,CAC1E,CACF,CAEA,OAAO,MAAML,yBAAyBlB,GACpCiB,IAAmB,AACnBY,CAAAA,SAAmB,CAAE,AAAF,CAAE,AAAC,AACtBF,CAAAA,GAAY,AAEZ,aAAYV,IAAkB,CAAE,CAC9B,KAAK,EACL,CAAA,IAAI,CAACA,IAAI,CAAGA,IACZ,CAAA,IAAI,CAACU,GAAG,CAAG1B,MAAM6B,SAAS,EAC5B,CAEAC,YAAYC,MAAc,CAAEC,GAAW,CAAU,CAC/C,GAAIvB,OAAO,IAAI,CAACO,IAAI,CAACd,MAAM,CAACqB,OAAO,IAAMQ,OAASC,IAAK,CAEvD,KAAO,CAEL,IAAI,CAAChB,IAAI,CAACd,MAAM,CAACa,QAAQ,CAACkB,OAAOF,OAASC,KAC5C,CACA,OAAOlC,KAAKuB,aAAa,AAC3B,CAEAa,eAA6D,CAC3D,MAAO,CAAEvB,IAAK,EAAGwB,OAAQ,IAAIrC,KAAKsC,MAAM,CAACtC,KAAK6B,qBAAqB,CAAE,EAAG,CAC1E,CAEAU,iBAA4D,CAC1D,MAAO,CACL1B,IAAK,EACL2B,SAAU,IAAIxC,KAAK2B,QAAQ,CACzB,IAAI,CAACC,GAAG,CACR5B,KAAK6B,qBAAqB,CAC1BlB,OAAO,IAAI,CAACO,IAAI,CAACd,MAAM,CAACqB,OAAO,IAEnC,CACF,CAGAgB,qBAAqBjB,IAAY,CAAU,CACzC,IAAI,CAACN,IAAI,CAACd,MAAM,CAACa,QAAQ,CAACkB,OAAOX,OACjC,OAAOxB,KAAKuB,aAAa,AAC3B,CAEAmB,QAAQlB,IAAY,CAAqC,CACvD,MAAMmB,IAAM,IAAIC,WAAWpB,MAC3B,MAAMqB,EAAI,IAAI,CAAC3B,IAAI,CAACd,MAAM,CAAC0C,IAAI,CAACH,IAAK,CAAEI,GAAIZ,OAAO,IAAI,CAACL,QAAQ,CAAE,EACjE,CAAA,IAAI,CAACA,QAAQ,EAAInB,OAAOkC,GACxB,MAAO,CAAEhC,IAAK,EAAGmC,KAAML,IAAIM,KAAK,CAAC,EAAGJ,EAAG,CACzC,CAEAxB,QACEY,MAAuB,CACvBiB,MAAc,CACmB,CACjC,IAAIC,kBACJ,OAAQD,QACN,KAAKlD,KAAKoD,UAAU,CAClBD,kBAAoBxC,OAAOsB,QAC3B,KACF,MAAKjC,KAAKqD,UAAU,CAClBF,kBAAoB,IAAI,CAACrB,QAAQ,CAAGnB,OAAOsB,QAC3C,KACF,MAAKjC,KAAKsB,UAAU,CAClB6B,kBAAoBxC,OAAO,IAAI,CAACO,IAAI,CAACd,MAAM,CAACqB,OAAO,IAAMd,OAAOsB,QAChE,KACF,SACE,MAAO,CAAEpB,IAAKb,KAAKsD,WAAW,CAAErB,OAAQ,CAAE,AAAF,CAAE,AAAC,CAC/C,CACA,GAAIkB,kBAAoB,EAAG,CACzB,MAAO,CAAEtC,IAAKb,KAAKsD,WAAW,CAAErB,OAAQ,CAAE,AAAF,CAAE,AAAC,CAC7C,CACA,IAAI,CAACH,QAAQ,CAAGqB,kBAChB,MAAO,CAAEtC,IAAKb,KAAKuB,aAAa,CAAEU,OAAQ,IAAI,CAACH,QAAQ,AAAC,CAC1D,CAEAyB,SAASP,IAAgB,CAAqC,CAC5D,GAAI,IAAI,CAAC9B,IAAI,CAACb,QAAQ,CAAE,MAAO,CAAEQ,IAAKb,KAAKwD,UAAU,CAAEC,SAAU,CAAE,EAGnE,MAAMZ,EAAI,IAAI,CAAC3B,IAAI,CAACd,MAAM,CAACsD,KAAK,CAACV,KAAM,CAAED,GAAIZ,OAAO,IAAI,CAACL,QAAQ,CAAE,EACnE,CAAA,IAAI,CAACA,QAAQ,EAAInB,OAAOkC,GACxB,MAAO,CAAEhC,IAAKb,KAAKuB,aAAa,CAAEkC,SAAUZ,CAAE,CAChD,CAEAc,SAAkB,CAChB,IAAI,CAACzC,IAAI,CAACd,MAAM,CAACwD,KAAK,GACtB,OAAO5D,KAAKuB,aAAa,AAC3B,CACF"}